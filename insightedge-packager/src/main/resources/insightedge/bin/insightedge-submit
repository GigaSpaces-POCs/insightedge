#!/usr/bin/env bash

set -e

DIRNAME=$(dirname ${BASH_SOURCE[0]})
source ${DIRNAME}/../conf/insightedge-env.sh

SUBMIT_ARGS=( "$@" )
# get length of an array
length=${#SUBMIT_ARGS[@]}

# loop over arguments to find if in deploy-mode cluster
for (( i=0; i<${length}; i++ ));
do
  if [[ ${SUBMIT_ARGS[$i]} == "--deploy-mode" && ${SUBMIT_ARGS[$(($i + 1))]} == "cluster" ]]; then
    # In cluster mode, local env variables override remote machine env variables
    # To fix this behavior:

    # 1. stop spark submit to source spark-env 
    export SPARK_ENV_LOADED=1

    # 2. empty i9e local classpaths env variable
    export SPARK_DIST_CLASSPATH=
  fi
done

"${SPARK_HOME}"/bin/spark-submit $@